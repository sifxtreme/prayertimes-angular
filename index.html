<!DOCTYPE html>
<html ng-app="prayerApp">
<head>  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body ng-controller="prayerCtrl">

<div>
	{{prayerTimesCalcArray}}
</div>

<div>
	{{clock | date : "hh:mm a"}}
</div>

<div>
	NEXT PRAYER = {{nextPrayer}}
</div>

<script type="text/javascript" src="praytimes.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.13/angular.min.js"></script>
<script type="text/javascript">
angular.module('prayerApp', [])
	.controller('prayerCtrl', ['$scope', '$http', '$timeout', '$interval', function($scope, $http, $timeout, $interval){

		var prayerTimesSet = false;

		var getLocation = function(){
			if(navigator.geolocation){
				console.log("getLocation");
				navigator.geolocation.getCurrentPosition(function(position){
					$scope.latitude = position.coords.latitude;
					$scope.longitude = position.coords.longitude;
					$scope.$apply(getPrayerTimes());
				},
				function(error){
					console.log("ERROR");
					console.log(error);	
				},
				{enableHighAccuracy:true, maximumAge:30000, timeout:27000});
			}
		}

		calculateCurrentPrayer = function(time, prayerArray){
			if(!prayerTimesSet){
				return;
			}
			else{
				var timeNow = new Date(time);
				var timeNowDecimal = timeNow.getHours() + timeNow.getMinutes()/60;

				var currentTimeAway = 24;
				var currentPrayerIndex = 5;

				for(var i=0; i<prayerArray.length; i++){
					
					var pTime = prayerArray[i].values[0] + prayerArray[i].values[1]/60;
					var currentDifference = timeNowDecimal -  pTime;

					if(currentDifference < currentTimeAway && currentDifference > 0){
						currentTimeAway = currentDifference;
						currentPrayerIndex = i;
					}
				}

				return prayerArray[currentPrayerIndex]
			}
		}

		calculateNextPrayer = function(time, prayerArray){
			if(!prayerTimesSet){
				return;
			}
			else{
				var timeNow = new Date(time);
				var timeNowArray = [timeNow.getHours(), timeNow.getMinutes()];
				
				var timeAway = 24;
				var selectedIndex = 0;
				
				for(var i=0; i<prayerArray.length; i++){
					var hourDifference = prayerArray[i].values[0] - timeNowArray[0];
					var minuteDifference = prayerArray[i].values[1] - timeNowArray[1];
					if((hourDifference > 0 && hourDifference < timeAway) || (hourDifference == 0 && minuteDifference > 0)){
						console.log('tru');
						timeAway = hourDifference;
						selectedIndex = i;
					}
				}
				return prayerArray[selectedIndex];
				
			}
		}

		$scope.clock = Date.now();
		var second = 1000;
		var minute = 60*second;
		$interval(function(){
			$scope.clock = Date.now();
		}, minute)

		var filterPrayerTimesForDisplay = function(prayerTimes){
			return [
				{ name: "Fajr", values: prayerTimes.fajr.split(":") },
				{ name: "Sunrise", values: prayerTimes.sunrise.split(":") },
				{ name: "Dhuhr", values: prayerTimes.dhuhr.split(":") },
				{ name: "Asr", values: prayerTimes.asr.split(":") },
				{ name: "Maghrib", values: prayerTimes.maghrib.split(":") },
				{ name: "Isha", values: prayerTimes.isha.split(":") },
			]
		}

		var filterPrayerTimesForCalculations = function(pTimes){
			return [
				Number(pTimes[0].values[0]) + Number(pTimes[0].values[1]) / 60,
				Number(pTimes[1].values[0]) + Number(pTimes[1].values[1]) / 60,
				Number(pTimes[2].values[0]) + Number(pTimes[2].values[1]) / 60,
				Number(pTimes[3].values[0]) + Number(pTimes[3].values[1]) / 60,
				Number(pTimes[4].values[0]) + Number(pTimes[4].values[1]) / 60,
				Number(pTimes[5].values[0]) + Number(pTimes[5].values[1]) / 60,
			]
		}

		var otherStuff = function(){
			$scope.prayerTimesDisplayArray = filterPrayerTimesForDisplay($scope.times);
			v = filterPrayerTimesForDisplay($scope.times);
			$scope.prayerTimesCalcArray = filterPrayerTimesForCalculations($scope.prayerTimesDisplayArray);

			// $scope.nextPrayer = calculateNextPrayer($scope.clock, $scope.prayerTimesArray);
			// v = calculateCurrentPrayer($scope.clock, $scope.prayerTimesArray);
			// "https://maps.googleapis.com/maps/api/timezone/outputFormat?parameters"
		}

		var getPrayerTimes = function(){
			console.log("getPrayerTimes");
			var d = new Date();
			var offset = d.getTimezoneOffset();
			var prayerOffset = offset / 60 * -1;
			$scope.times = prayTimes.getTimes(d, [$scope.latitude, $scope.longitude], prayerOffset);
			prayerTimesSet = true;

			otherStuff();
		}			


		getLocation();

		
	}])
		
</script>

</body>
</html>