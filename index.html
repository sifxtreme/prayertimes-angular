<!DOCTYPE html>
<html ng-app="prayerApp">
<head>  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" type="text/css" href="autocomplete.css">
</head>
<body ng-controller="prayerCtrl">

<div id="main" ng-cloak style="background: linear-gradient(to bottom, {{topColor}}, {{bottomColor}}">

	<section ng-show="showOptions">
		<input type="text" placeholder="Enter your location" g-places-autocomplete ng-model="place" />
	</section>

	<section class="header">
		<div ng-click="showOptionsView(true)" class="show-options-button"><img src="gear.svg"></div>
		<div id="clock">
			{{clock | date : "hh:mm:ss a"}}
		</div>

	</section>

	<section class="headlines">
		<div id="currentPrayer">
			CURRENT PRAYER
		</div>
		<div id="currentPrayerTime">
			<span>{{currentPrayerString}} {{currentPrayerTimeString}}</span>
		</div>
		<div id="till">
			{{timeTillNextPrayerString}} {{nextPrayer.name}}
		</div>
	</section>

	<div id="times">
		<section>
			<div class="col">
				<p>FAJR</p><p class="actual-time">{{convertTimeValueForDisplay(prayerTimesDisplayArray[0].values)}}</p>
				<div class="clear"></div>
				<p>SUNRISE</p><p class="actual-time">{{convertTimeValueForDisplay(prayerTimesDisplayArray[1].values)}}</p>
				<div class="clear"></div>
				<p>DHUHR</p><p class="actual-time">{{convertTimeValueForDisplay(prayerTimesDisplayArray[2].values)}}</p>
				<div class="clear"></div>
			</div>
			<div class="col">
				<p>ASR</p><p class="actual-time">{{convertTimeValueForDisplay(prayerTimesDisplayArray[3].values)}}</p>
				<div class="clear"></div>
				<p>MAGHRIB</p><p class="actual-time">{{convertTimeValueForDisplay(prayerTimesDisplayArray[4].values)}}</p>
				<div class="clear"></div>
				<p>ISHA</p><p class="actual-time">{{convertTimeValueForDisplay(prayerTimesDisplayArray[5].values)}}</p>
				<div class="clear"></div>
			</div>
		</section>
	</div>

	<div id="test">
		{{minutesSinceStart}} - {{minutesTillNext}}
	</div>
</div>

<script type="text/javascript" src="praytimes.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.13/angular.min.js"></script>
<script src="autocomplete.js"></script>
<script type="text/javascript">
angular.module('prayerApp', ['google.places'])
	.controller('prayerCtrl', ['$scope', '$http', '$timeout', '$interval', function($scope, $http, $timeout, $interval){

		$scope.$watch("place", function(newVal, oldVal){
			if(typeof newVal == "object"){
				$scope.latitude = newVal.geometry.location.lat();
				$scope.longitude = newVal.geometry.location.lng();

				getPrayerTimes(new Date(), $scope.latitude, $scope.longitude);
			}
		})

		var colors = {
			Fajr: { start: {r: 154, g: 94, b: 247}, end: {r: 247, g: 145, b: 111} },
			Sunrise: { start: {r: 247, g: 145, b: 111}, end: {r: 185, g: 228, b: 246} },
			Dhuhr: { start: {r: 185, g: 228, b: 246}, end: {r: 63, g: 169, b: 245} },
			Asr: { start: {r: 63, g: 169, b: 245}, end: {r: 251, g: 121, b: 120} },
			Maghrib: { start: {r: 251, g: 121, b: 120}, end: {r: 1, g: 82, b: 180} },
			Isha: { start: {r: 1, g: 82, b: 180}, end: {r: 154, g: 94, b: 247} },
		}

		var makeColorPiece = function(num){
			num = Math.min(num, 255);   // not more than 255
			num = Math.max(num, 0);     // not less than 0
			var str = num.toString(16);
			if (str.length < 2) {
			    str = "0" + str;
			}
			return(str);
		}

		convertToHexString = function(colorRGB){
			return "#" + makeColorPiece(colorRGB.r) + makeColorPiece(colorRGB.g) + makeColorPiece(colorRGB.b);
		}

		var makeGradientColor = function(color1, color2, percent){
			var newColor = {};

			function makeChannel(a, b) {
	      return(a + Math.round((b-a)*(percent/100)));
	    }

	    newColor.r = makeChannel(color1.r, color2.r);
	    newColor.g = makeChannel(color1.g, color2.g);
	    newColor.b = makeChannel(color1.b, color2.b);

	    return newColor;
		}

		var setColor = function(){
			var percentageOfSectionPassed = ($scope.minutesSinceStart*100) / ($scope.minutesSinceStart + $scope.minutesTillNext)/2 + 50;
			$scope.topColor = convertToHexString(colors[$scope.currentPrayerName].start)
			$scope.bottomColor = convertToHexString(makeGradientColor(colors[$scope.currentPrayerName].start, colors[$scope.currentPrayerName].end, percentageOfSectionPassed));
		}

		var getLocation = function(){
			if(navigator.geolocation){
				console.log("getLocation");
				navigator.geolocation.getCurrentPosition(function(position){
					$scope.latitude = position.coords.latitude;
					$scope.longitude = position.coords.longitude;
					$scope.$apply(getPrayerTimes(new Date(), $scope.latitude, $scope.longitude));
				},
				function(error){
					console.log("ERROR");
					console.log(error);	
					$scope.showOptions = true;
				},
				{enableHighAccuracy:true, maximumAge:30000, timeout:27000});
			}
		}

		calculateNextPrayerIndex = function(time, prayerArray){
			var currentTimeAway = 24;
			var currentPrayerIndex = 5;

			var nextTimeAway = 24;
			var nextPrayerIndex = 0;

			for(var i=0; i<prayerArray.length; i++){
				
				var currentDifference = time -  prayerArray[i];
				var nextDifference = prayerArray[i] - time;

				if(currentDifference < currentTimeAway && currentDifference > 0){
					currentTimeAway = currentDifference;
					currentPrayerIndex = i;
				}
				if(nextDifference < nextTimeAway && nextDifference > 0){
					nextTimeAway = nextDifference;
					nextPrayerIndex = i;
				}
			}

			return nextPrayerIndex;
		}

		var minutesSinceBeginningOfCurrentPrayer = function(time, beginningTime){
			return Math.round((((time - beginningTime)+24)%24)*60);
		}

		var minutesTillNextPrayer = function(time, nextTime){
			return Math.round((((nextTime - time)+24)%24)*60);
		}

		var timeTillNextPrayerString = function(minutes){
			if(minutes < 60){
				return minutes + " minute"+(parseInt(minutes) == 1 ? "" : "s")+" till";
			}
			else{
				return "More than " + parseInt(minutes/60) + " hour"+(parseInt(minutes/60) == 1 ? "" : "s")+" till";
			}
		}

		var secondCounter = 0;
		var onUpdateTime = function(){
			var d = new Date();
			$scope.clock = d.getTime();
			var timeNow = new Date($scope.clock);
			var timeNowDecimal = timeNow.getHours() + timeNow.getMinutes()/60;
			
			if(!prayerTimesSet){ return; }

			getCurrentAndNextPrayer(timeNowDecimal);

			if(secondCounter >= 30){
				secondCounter = 0;
				setColor();
			}
			secondCounter++;
		}

		var setUpTime = function(){
			$scope.clock = Date.now();
			var second = 1000;
			var minute = 60*second;
			$interval(onUpdateTime, second)
		}


		var filterPrayerTimesForDisplay = function(prayerTimes){
			return [
				{ name: "Fajr", values: prayerTimes.fajr.split(":") },
				{ name: "Sunrise", values: prayerTimes.sunrise.split(":") },
				{ name: "Dhuhr", values: prayerTimes.dhuhr.split(":") },
				{ name: "Asr", values: prayerTimes.asr.split(":") },
				{ name: "Maghrib", values: prayerTimes.maghrib.split(":") },
				{ name: "Isha", values: prayerTimes.isha.split(":") },
			]
		}

		var filterPrayerTimesForCalculations = function(pTimes){
			return [
				Number(pTimes[0].values[0]) + Number(pTimes[0].values[1]) / 60,
				Number(pTimes[1].values[0]) + Number(pTimes[1].values[1]) / 60,
				Number(pTimes[2].values[0]) + Number(pTimes[2].values[1]) / 60,
				Number(pTimes[3].values[0]) + Number(pTimes[3].values[1]) / 60,
				Number(pTimes[4].values[0]) + Number(pTimes[4].values[1]) / 60,
				Number(pTimes[5].values[0]) + Number(pTimes[5].values[1]) / 60,
			]
		}

		$scope.convertTimeValueForDisplay = function(time){
			if(typeof time !== "object"){
				return;
			}
			var isAmOrPm = 0;
			var hours = time[0];
			var minutes = time[1];
			if(hours / 12 >= 1){
				isAmOrPm = 1;
				hours = hours % 12;
			}
			if(hours == 0){
				hours = 12;
			}
			hours = parseInt(hours);

			return hours + ":" + minutes + (isAmOrPm ? " PM" : " AM")
		}

		var formatHeadlineText = function(currentPrayerIndex, nextPrayerIndex, timeNowDecimal){
			$scope.currentPrayerName = $scope.prayerTimesDisplayArray[currentPrayerIndex].name
			$scope.currentPrayerTime = $scope.convertTimeValueForDisplay($scope.prayerTimesDisplayArray[currentPrayerIndex].values)

			if(currentPrayerIndex != 1){
				$scope.currentPrayerString = $scope.currentPrayerName;
				$scope.currentPrayerTimeString = "(" + $scope.currentPrayerTime + ")";
			}
			else{
				$scope.currentPrayerString = "NO FARD";
				$scope.currentPrayerTimeString = "";
			}

			$scope.minutesSinceStart = minutesSinceBeginningOfCurrentPrayer(timeNowDecimal, $scope.prayerTimesCalcArray[currentPrayerIndex]);
			$scope.minutesTillNext = minutesTillNextPrayer(timeNowDecimal, $scope.prayerTimesCalcArray[nextPrayerIndex]);

			$scope.nextPrayer = $scope.prayerTimesDisplayArray[nextPrayerIndex];
			$scope.timeTillNextPrayerString = timeTillNextPrayerString($scope.minutesTillNext);
		}

		var getCurrentAndNextPrayer = function(timeNowDecimal){
			var nextPrayerIndex = calculateNextPrayerIndex(timeNowDecimal, $scope.prayerTimesCalcArray);
			var currentPrayerIndex = 0;

			currentPrayerIndex = nextPrayerIndex - 1;
			if(currentPrayerIndex < 0) currentPrayerIndex = 5;
			if(nextPrayerIndex == 1) nextPrayerIndex = 2;

			formatHeadlineText(currentPrayerIndex, nextPrayerIndex, timeNowDecimal);
		}

		var setUpArrays = function(){
			$scope.prayerTimesDisplayArray = filterPrayerTimesForDisplay($scope.times);
			$scope.prayerTimesCalcArray = filterPrayerTimesForCalculations($scope.prayerTimesDisplayArray);
			console.log($scope.prayerTimesDisplayArray);
		}

		var getPrayerTimes = function(date, latitude, longitude){
			var offset = date.getTimezoneOffset();
			var prayerOffset = offset / 60 * -1;
			prayerOffset = -7;

			// console.log(prayerOffset);

			$scope.times = prayTimes.getTimes(date, [latitude, longitude], prayerOffset);
			prayerTimesSet = true;

			setUpArrays();
			onUpdateTime();
			setColor();
		}

		var prayerTimesSet = false;
		var init = function(){
			prayTimes.setMethod("ISNA");
			setUpTime();
			getLocation();
		}

		$scope.showOptionsView = function(show){
			$scope.showOptions = show;
		}

		init();

	}])
		
</script>

</body>
</html>